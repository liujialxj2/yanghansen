---
import BaseLayout from '../layouts/BaseLayout.astro';
import { formatImageUrl } from '../lib/apos';
import { t } from 'i18next';
import dayjs from 'dayjs';
import VideoGrid from '../components/VideoGrid.astro';

// 获取页面数据
const { data } = Astro.props;
const video = data?.piece || {};
const title = video.title || t('videos.videoDetail');
const relatedVideos = data?.related || [];

// 辅助函数：将视频URL转换为嵌入式URL
const getEmbedUrl = (videoUrl) => {
  if (!videoUrl) return '';
  
  // 处理YouTube链接
  if (videoUrl.includes('youtube.com') || videoUrl.includes('youtu.be')) {
    const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = videoUrl.match(youtubeRegex);
    if (match && match[1]) {
      return `https://www.youtube.com/embed/${match[1]}?autoplay=0&rel=0`;
    }
  }
  
  // 处理Vimeo链接
  if (videoUrl.includes('vimeo.com')) {
    const vimeoRegex = /vimeo\.com\/(?:.*\/)?(?:.*\/)?(\d+)(?:$|\/|\?)/;
    const match = videoUrl.match(vimeoRegex);
    if (match && match[1]) {
      return `https://player.vimeo.com/video/${match[1]}`;
    }
  }
  
  // 如果无法解析，返回原始URL
  return videoUrl;
};

// 获取视频类别的本地化名称
const getCategoryLabel = (category) => {
  const categoryMap = {
    'highlights': t('videos.categories.highlights'),
    'interviews': t('videos.categories.interviews'),
    'training': t('videos.categories.training'),
    'behindScenes': t('videos.categories.behindScenes')
  };
  return categoryMap[category] || category;
};

const embedUrl = getEmbedUrl(video.videoUrl);
---

<BaseLayout title={title}>
  <div class="video-detail-page">
    <section class="section">
      <div class="container">
        <nav class="breadcrumb" aria-label="breadcrumbs">
          <ul>
            <li><a href="/">{t('nav.home')}</a></li>
            <li><a href="/videos">{t('nav.videos')}</a></li>
            <li class="is-active"><a href="#" aria-current="page">{title}</a></li>
          </ul>
        </nav>
        
        <div class="video-player-container">
          <div class="video-player-wrapper">
            <iframe 
              src={embedUrl} 
              class="video-player" 
              frameborder="0" 
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
              allowfullscreen
              loading="lazy"
              title={title}
            ></iframe>
          </div>
          
          <div class="video-meta-info">
            <h1 class="title is-2">{title}</h1>
            
            <div class="video-meta">
              {video.category && (
                <span class="tag is-danger mr-2">{getCategoryLabel(video.category)}</span>
              )}
              {video.recordDate && (
                <span class="video-date">
                  <span class="icon"><i class="far fa-calendar"></i></span>
                  {dayjs(video.recordDate).format('YYYY.MM.DD')}
                </span>
              )}
              {video.duration && (
                <span class="video-duration">
                  <span class="icon"><i class="far fa-clock"></i></span>
                  {video.duration}
                </span>
              )}
            </div>
            
            {video.description && (
              <div class="video-description content">
                <p>{video.description}</p>
              </div>
            )}
            
            <div class="video-share">
              <span class="share-label">{t('common.share')}:</span>
              <div class="social-buttons">
                <a href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url}`} target="_blank" class="social-button">
                  <span class="icon"><i class="fab fa-facebook-f"></i></span>
                </a>
                <a href={`https://twitter.com/intent/tweet?url=${Astro.url}&text=${encodeURIComponent(title)}`} target="_blank" class="social-button">
                  <span class="icon"><i class="fab fa-twitter"></i></span>
                </a>
                <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${Astro.url}`} target="_blank" class="social-button">
                  <span class="icon"><i class="fab fa-linkedin-in"></i></span>
                </a>
                <a href={`https://api.whatsapp.com/send?text=${encodeURIComponent(title + ' ' + Astro.url)}`} target="_blank" class="social-button">
                  <span class="icon"><i class="fab fa-whatsapp"></i></span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    {/* 相关视频区块 */}
    <section class="section related-videos-section">
      <div class="container">
        <h2 class="title is-3">{t('videos.relatedVideos')}</h2>
        <VideoGrid videos={relatedVideos} columns={4} />
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .video-detail-page {
    padding-bottom: 3rem;
  }
  
  .breadcrumb {
    margin-bottom: 2rem;
  }
  
  .video-player-container {
    margin-bottom: 2rem;
  }
  
  .video-player-wrapper {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
    overflow: hidden;
    border-radius: 6px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
  }
  
  .video-player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }
  
  .video-meta-info {
    padding: 1rem 0;
  }
  
  .video-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }
  
  .video-date, .video-duration {
    margin-right: 1.5rem;
    color: #888;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
  }
  
  .video-date .icon, .video-duration .icon {
    margin-right: 0.5rem;
  }
  
  .video-description {
    margin-bottom: 1.5rem;
    line-height: 1.6;
    color: #f5f5f5;
  }
  
  .video-share {
    display: flex;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  .share-label {
    margin-right: 1rem;
    color: #888;
  }
  
  .social-buttons {
    display: flex;
  }
  
  .social-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.1);
    color: #f5f5f5;
    margin-right: 0.75rem;
    transition: all 0.2s ease;
  }
  
  .social-button:hover {
    background-color: #E03A3E;
    color: white;
    transform: translateY(-3px);
  }
  
  .related-videos-section {
    background-color: rgba(255,255,255,0.03);
    border-top: 1px solid rgba(255,255,255,0.05);
  }
</style> 