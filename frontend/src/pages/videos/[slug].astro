---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getLangInfo } from '../../lib/multilingual';
import { t } from "i18next";
import dayjs from 'dayjs';
import VideoGrid from '../../components/VideoGrid.astro';

// 获取语言信息
const { lang } = getLangInfo(Astro.url);

// 获取URL参数
const { slug } = Astro.params;

// 模拟从API获取视频详情（此处应根据slug从数据库获取）
const video = {
  _id: '1', 
  title: '杨瀚森NBA首秀精彩集锦 | Hansen Yang NBA Debut Highlights',
  _url: '/videos/nba-debut',
  videoUrl: 'https://www.youtube.com/embed/XRpakobyQGw',
  duration: '4:35',
  recordDate: '2025-10-28',
  category: 'highlights',
  description: '杨瀚森在NBA首秀中展示了他独特的传球视野和篮下终结能力，全场贡献12分6篮板4助攻。',
  views: 15789,
  likes: 876
};

// 准备页面标题
const title = video.title;

// 相关视频（模拟数据）
const relatedVideos = [
  { 
    _id: '2', 
    title: '赛后采访：杨瀚森谈加盟开拓者的感受 | Post-Game Interview',
    _url: '/videos/post-game-interview',
    videoUrl: 'https://www.youtube.com/watch?v=noqGIyAQvNI',
    duration: '5:12',
    recordDate: '2025-06-28',
    category: 'interviews',
    description: '杨瀚森在被选中后表示："这是我人生中最重要的时刻之一，我非常感谢波特兰球队的信任。"'
  },
  { 
    _id: '3', 
    title: '训练日记：备战NBA赛季 | Training Camp Diary',
    _url: '/videos/training-camp',
    videoUrl: 'https://www.tiktok.com/@trailblazers/video/7520414337781992734',
    duration: '3:24',
    recordDate: '2025-09-15',
    category: 'training',
    description: '跟随镜头记录杨瀚森加入开拓者队后的季前训练营，展示他如何适应NBA强度的训练。'
  },
  { 
    _id: '4', 
    title: '杨瀚森NCAA选秀联合试训表现 | NBA Draft Combine',
    _url: '/videos/draft-combine',
    videoUrl: 'https://www.youtube.com/watch?v=oeKFV7vaZkE',
    duration: '7:18',
    recordDate: '2025-05-15',
    category: 'highlights',
    description: '杨瀚森在NBA选秀联合试训中展现的"华丽传球"甚至赢得了与三届MVP尼古拉·约基奇的比较。'
  }
];

// 转换YouTube链接为嵌入格式
function getEmbedUrl(url) {
  if (url.includes('youtube.com/watch')) {
    return url.replace('watch?v=', 'embed/');
  } else if (url.includes('youtu.be')) {
    const videoId = url.split('/').pop();
    return `https://www.youtube.com/embed/${videoId}`;
  }
  return url;
}

// 获取视频类别的本地化名称
function getCategoryLabel(category) {
  const categoryMap = {
    'highlights': t('videos.categories.highlights'),
    'interviews': t('videos.categories.interviews'),
    'training': t('videos.categories.training'),
    'behindScenes': t('videos.categories.behindScenes')
  };
  return categoryMap[category] || category;
}
---

<BaseLayout title={title}>
  <div class="video-detail">
    <section class="section pt-5 pb-2">
      <div class="container">
        <nav class="breadcrumb" aria-label="breadcrumbs">
          <ul>
            <li><a href="/">{t('common.home')}</a></li>
            <li><a href="/videos">{t('common.videos')}</a></li>
            <li class="is-active"><a href="#" aria-current="page">{video.title}</a></li>
          </ul>
        </nav>
      </div>
    </section>
    
    <section class="section pt-2">
      <div class="container">
        <div class="columns">
          <div class="column is-8">
            <!-- 视频播放器 -->
            <div class="video-player-container">
              <iframe 
                class="video-player"
                src={getEmbedUrl(video.videoUrl)} 
                title={video.title}
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
              </iframe>
            </div>
            
            <!-- 视频信息 -->
            <div class="video-info mt-4">
              <h1 class="title is-3">{video.title}</h1>
              
              <div class="meta-info">
                <div class="tags">
                  <span class="tag is-danger">{getCategoryLabel(video.category)}</span>
                </div>
                <div class="stats">
                  <span class="icon-text mr-4">
                    <span class="icon"><i class="fas fa-calendar"></i></span>
                    <span>{dayjs(video.recordDate).format('YYYY.MM.DD')}</span>
                  </span>
                  <span class="icon-text mr-4">
                    <span class="icon"><i class="fas fa-eye"></i></span>
                    <span>{video.views.toLocaleString()}</span>
                  </span>
                  <span class="icon-text">
                    <span class="icon"><i class="fas fa-heart"></i></span>
                    <span>{video.likes.toLocaleString()}</span>
                  </span>
                </div>
              </div>
              
              <div class="description mt-5">
                <h3 class="title is-5">{t('videos.description')}</h3>
                <p>{video.description}</p>
              </div>
              
              <div class="share-buttons mt-5">
                <h3 class="title is-5">{t('videos.share')}</h3>
                <div class="buttons">
                  <button class="button is-outlined">
                    <span class="icon"><i class="fab fa-weibo"></i></span>
                    <span>{t('common.shareOn')} Weibo</span>
                  </button>
                  <button class="button is-outlined">
                    <span class="icon"><i class="fab fa-weixin"></i></span>
                    <span>{t('common.shareOn')} WeChat</span>
                  </button>
                  <button class="button is-outlined">
                    <span class="icon"><i class="fab fa-twitter"></i></span>
                    <span>{t('common.shareOn')} Twitter</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="column is-4">
            <!-- 相关视频 -->
            <div class="related-videos">
              <h3 class="title is-4">{t('videos.related')}</h3>
              
              {relatedVideos.map(relatedVideo => (
                <div class="related-video-item mb-4">
                  <a href={relatedVideo._url} class="media">
                    <div class="media-left">
                      <div class="image is-96x96 related-thumbnail">
                        <div class="play-icon">
                          <span class="icon"><i class="fas fa-play"></i></span>
                        </div>
                        <div class="duration">{relatedVideo.duration}</div>
                      </div>
                    </div>
                    <div class="media-content">
                      <p class="related-title">{relatedVideo.title}</p>
                      <p class="related-date">
                        {dayjs(relatedVideo.recordDate).format('YYYY.MM.DD')}
                      </p>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 更多视频推荐 -->
    <section class="section">
      <div class="container">
        <VideoGrid 
          videos={relatedVideos}
          title={t('videos.moreVideos')}
          showViewAll={true}
          columns={4}
        />
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .video-player-container {
    position: relative;
    padding-top: 56.25%; /* 16:9 宽高比 */
    width: 100%;
  }
  
  .video-player {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 8px;
  }
  
  .meta-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #eee;
  }
  
  .stats {
    display: flex;
    align-items: center;
    color: #666;
  }
  
  .description {
    padding-bottom: 1.5rem;
    border-bottom: 1px solid #eee;
  }
  
  .share-buttons .buttons {
    flex-wrap: nowrap;
  }
  
  .related-videos {
    padding: 1.5rem;
    background-color: #f9f9f9;
    border-radius: 8px;
  }
  
  .related-thumbnail {
    position: relative;
    overflow: hidden;
    border-radius: 6px;
  }
  
  .play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }
  
  .related-video-item:hover .play-icon {
    opacity: 1;
  }
  
  .duration {
    position: absolute;
    bottom: 5px;
    right: 5px;
    background-color: rgba(0,0,0,0.7);
    color: white;
    padding: 1px 4px;
    border-radius: 3px;
    font-size: 0.7rem;
  }
  
  .related-title {
    font-weight: 600;
    font-size: 0.9rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }
  
  .related-date {
    font-size: 0.8rem;
    color: #888;
  }
</style> 